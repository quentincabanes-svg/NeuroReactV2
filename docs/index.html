<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NeuroReactV2 – LFDS (No-deps)</title>
  <style>
    :root{
      --bg:#f5f5f6; --panel:#fff; --text:#121212; --muted:#6b7280; --border:#e5e7eb;
      --brand:#fb8c00; --brand-600:#f57c00; --brand-50:#fff3e0;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .app{min-height:100dvh;display:flex;flex-direction:column}
    .container{max-width:1200px;margin:0 auto;padding:0 16px}

    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    header .bar{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:10px;border:1px solid var(--border);display:grid;place-items:center;background:#fff;overflow:hidden}
    .logo span{font-size:11px;font-weight:800;color:#6b7280}
    .button{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:700;font-size:12px;background:var(--brand);color:#fff;cursor:pointer;box-shadow:0 1px 1px rgba(0,0,0,.05)}
    .button:hover{background:var(--brand-600)}

    main.layout{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px 0}
    @media (max-width:980px){main.layout{grid-template-columns:1fr}}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .panel h2{margin:0 0 8px;font-size:14px;font-weight:700}
    .section{margin-bottom:16px}
    .section h3{margin:0 0 8px;font-size:12px;font-weight:700;color:#374151;letter-spacing:.02em}
    .section .box{border:1px solid var(--border);border-radius:14px;background:#fff;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);background:#fff;padding:6px 10px;font:600 13px/1 system-ui,sans-serif;border-radius:999px;cursor:pointer;box-shadow:0 1px 1px rgba(0,0,0,.04)}
    .chip.active{border-color:var(--brand);background:#fff7ed;color:#9a3412}

    .swatches{display:flex;flex-wrap:wrap;gap:8px}
    .swatch{width:40px;height:40px;border-radius:8px;border:1px solid var(--border);display:grid;place-items:center;font:700 10px/1 system-ui;color:#fff;cursor:pointer}
    .swatch.active{outline:2px solid var(--brand);outline-offset:2px}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    label.lbl{display:block;font:600 12px/1 system-ui;color:#374151;margin-bottom:6px}
    input[type="number"],input[type="range"]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font:600 13px/1 system-ui;background:#fff;outline:none}
    input[type="number"]:focus,input[type="range"]:focus{box-shadow:0 0 0 2px #fed7aa;border-color:#fdba74}

    .checkbox{display:flex;align-items:center;gap:8px;font:600 13px/1 system-ui}

    .actions{display:flex;gap:8px}
    .btn-outline{background:#fff;color:#c2410c;border:1px solid #fed7aa}

    /* Stage shell (cible du plein écran) */
    .stage-shell{position:relative;border-radius:16px;border:1px solid var(--border);background:#fff;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .fs-exit{position:absolute;right:12px;top:12px;z-index:30;background:rgba(17,17,17,.75);color:#fff;border:0;border-radius:8px;padding:6px 10px;font:700 12px/1 system-ui}

    .progress{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    .progress .card{background:#eef2f7;border-radius:12px;padding:12px}
    .progress .row{display:flex;align-items:center;justify-content:space-between;font:700 12px/1 system-ui;color:#4b5563;margin-bottom:6px}
    .bar{height:8px;width:100%;background:#fff;border-radius:6px;overflow:hidden;border:1px solid var(--border)}
    .bar .fill{height:100%;background:var(--brand);width:0%;transition:width .2s linear}

    .stage{position:relative;display:flex;min-height:60vh;flex:1;overflow:hidden;border-radius:12px;background:#f3f4f6}

    /* Overlays */
    .overlay{position:absolute;inset:0;display:grid;place-items:center}
    .overlay.countdown{background:rgba(255,255,255,.7)}
    .overlay.rest{background:var(--brand-50);text-align:center}
    .count{font:900 20vh/1 system-ui;color:#0f172a}
    .rest-title{font:800 8vh/1 system-ui;color:#9a3412}
    .rest-num{font:900 18vh/1 system-ui;color:#c2410c}
    .rest-sub{margin-top:6px;font:600 12px/1 system-ui;color:#9a3412}

    /* Stimulus */
    .stimulus{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(1);font-weight:900;text-align:center;text-shadow:0 4px 6px rgba(0,0,0,.12);user-select:none;will-change:transform}
    .bg-layer{position:absolute;inset:0;opacity:.9}

    footer{border-top:1px solid var(--border);background:#fff}
    footer .bar{padding:10px 0;color:#6b7280;font-size:12px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="container bar">
      <div class="brand">
        <div class="logo"><span>LFDS</span></div>
        <div>
          <div style="font:800 13px/1 system-ui;letter-spacing:.02em">LA FORGE DES SOMMETS</div>
          <div style="font:600 11px/1 system-ui;color:#6b7280">Neurocognition · Réactivité</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="button" id="btn-stop-header" style="display:none;background:#fff;color:#c2410c;border:1px solid #fed7aa">STOP</button>
        <button class="button" id="btn-toggle-fs">Plein écran (F)</button>
      </div>
    </div>
  </header>

  <main class="container layout">
    <!-- Panneau gauche -->
    <aside class="panel">
      <div class="section">
        <h2>Mode <span style="font:600 11px/1 system-ui;color:#6b7280;margin-left:8px">(Espace = Start/Stop)</span></h2>
        <div class="chips" id="mode-chips"></div>
      </div>

      <div class="section">
        <h2>Sélections</h2>
        <div class="section">
          <h3>Couleurs (texte/éléments)</h3>
          <div class="box"><div class="swatches" id="swatches-colors"></div></div>
        </div>
        <div class="section" id="sec-numbers" style="display:none">
          <h3>Chiffres</h3>
          <div class="box"><div class="chips" id="chips-numbers"></div></div>
        </div>
        <div class="section" id="sec-dirs" style="display:none">
          <h3>Directions</h3>
          <div class="box"><div class="chips" id="chips-dirs"></div></div>
        </div>
        <div class="section" id="sec-bgs" style="display:none">
          <h3>Couleurs de fond</h3>
          <div class="box"><div class="swatches" id="swatches-bgs"></div></div>
        </div>
        <div class="section" id="sec-multi" style="display:none">
          <h3>Types inclus (Multi)</h3>
          <div class="box"><div class="chips" id="chips-multi"></div></div>
        </div>
      </div>

      <div class="section">
        <h2>Paramètres</h2>
        <div class="grid2">
          <div>
            <label class="lbl">Durée d’apparition</label>
            <input type="number" id="inp-appear" min="50" max="5000" step="50" value="500">
            <div style="font:600 11px/1 system-ui;color:#6b7280">ms (pas 50)</div>
          </div>
          <div>
            <label class="lbl">Intervalle entre apparitions</label>
            <input type="number" id="inp-interval" min="0" max="5000" step="50" value="500">
            <div style="font:600 11px/1 system-ui;color:#6b7280">ms (pas 50)</div>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label class="lbl">Type de répétition</label>
            <div class="chips">
              <button class="chip active" data-reptype="apparitions">Apparitions</button>
              <button class="chip" data-reptype="duree">Durée</button>
            </div>
          </div>
          <div>
            <label class="lbl">Taille du stimulus</label>
            <input type="range" id="inp-size" min="8" max="40" step="1" value="24">
          </div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label class="lbl">Sets</label>
            <input type="number" id="inp-sets" min="1" max="999" step="1" value="3">
          </div>
          <div id="box-reps">
            <label class="lbl">Répétitions / set</label>
            <input type="number" id="inp-reps" min="1" max="999" step="1" value="20">
          </div>
          <div id="box-duration" style="display:none">
            <label class="lbl">Durée par set</label>
            <input type="number" id="inp-setdur" min="1" max="3600" step="1" value="30">
            <div style="font:600 11px/1 system-ui;color:#6b7280">secondes</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <label class="lbl">Récupération entre sets</label>
          <input type="number" id="inp-rest" min="1" max="3600" step="1" value="30">
          <div style="font:600 11px/1 system-ui;color:#6b7280">secondes</div>
        </div>

        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:10px">
          <label class="checkbox"><input type="checkbox" id="chk-rand"> Emplacement aléatoire (marges de sécurité)</label>
          <label class="checkbox"><input type="checkbox" id="chk-beep"> Bip au début de chaque apparition</label>
          <label class="checkbox"><input type="checkbox" id="chk-autofs"> Plein écran au démarrage (zone stimuli)</label>
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="button" id="btn-start">Démarrer</button>
          <button class="button btn-outline" id="btn-stop" style="display:none">Stop</button>
        </div>
      </div>
    </aside>

    <!-- Zone de stimuli (shell plein écran) -->
    <section class="stage-shell" id="stage-shell">
      <button class="fs-exit" id="btn-exit-fs" style="display:none">Quitter plein écran</button>

      <div class="progress">
        <div class="card">
          <div class="row"><span>Set</span><span id="txt-set">0/0</span></div>
          <div class="bar"><div class="fill" id="bar-set"></div></div>
        </div>
        <div class="card">
          <div class="row"><span id="lbl-rep">Répétitions</span><span id="txt-rep">0/0</span></div>
          <div class="bar"><div class="fill" id="bar-rep"></div></div>
        </div>
      </div>

      <div class="stage" id="stage">
        <div class="overlay countdown" id="ov-count" style="display:none"><div class="count" id="count-num">3</div></div>
        <div class="overlay rest" id="ov-rest" style="display:none">
          <div>
            <div class="rest-title">RÉCUP</div>
            <div class="rest-num" id="rest-num">0</div>
            <div class="rest-sub">secondes</div>
          </div>
        </div>
        <!-- layers injectés ici -->
      </div>
    </section>
  </main>

  <footer>
    <div class="container bar">
      <div>© <span id="year"></span> La Forge des Sommets — Prototype d’entraînement neurocognitif</div>
      <div>Thème clair • Orange & Noir · Espace: Start/Stop · F: Plein écran</div>
    </div>
  </footer>
</div>

<script>
"use strict";

/* ==================== Données ==================== */
const COLORS = [
  { name: 'ROUGE', hex: '#E53935' },
  { name: 'VERT', hex: '#43A047' },
  { name: 'BLEU', hex: '#1E88E5' },
  { name: 'JAUNE', hex: '#FDD835' },
  { name: 'ORANGE', hex: '#FB8C00' },
  { name: 'VIOLET', hex: '#8E24AA' },
  { name: 'ROSE', hex: '#E91E63' },
  { name: 'NOIR', hex: '#111111' },
  { name: 'BLANC', hex: '#FFFFFF', outline: true },
  { name: 'GRIS', hex: '#9E9E9E' },
  { name: 'MARRON', hex: '#6D4C41' },
];
const NUMBERS = Array.from({length:10}, (_,i)=>i);
const DIRECTIONS = [
  { key: 'haut', label: '↑' }, { key: 'bas', label: '↓' }, { key: 'gauche', label: '←' }, { key: 'droite', label: '→' },
  { key: 'haut_droite', label: '↗' }, { key: 'bas_droite', label: '↘' }, { key: 'bas_gauche', label: '↙' }, { key: 'haut_gauche', label: '↖' },
];

const STORAGE_KEY='neuroreactv2_settings';

const state = {
  mode: 'stroop',
  repType: 'apparitions',
  selectedColors: COLORS.map(c=>c.name),
  selectedBgColors: COLORS.map(c=>c.name),
  selectedNumbers: [...NUMBERS],
  selectedDirections: DIRECTIONS.map(d=>d.key),
  appearanceMs: 500,
  intervalMs: 500,
  sets: 3,
  reps: 20,
  setDurationSec: 30,
  restSec: 30,
  sizeVH: 24,
  randomPos: false,
  beep: false,
  autoFullscreen: false,
  multiPool: { stroop:true, chiffres:true, couleur:true, directions:true, chiffreCouleur:true, directionCouleur:true },
  // runtime
  phase:'idle', currentSet:0, currentRep:0, runningSetElapsedMs:0,
  cancelled:false,
};

const randFrom = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const clamp=(n,lo,hi)=>Math.max(lo,Math.min(hi,n));

/* ==================== Raccourcis DOM ==================== */
const q = (id)=>document.getElementById(id);
const stageShell = q('stage-shell');
const stage = q('stage');
const ovCount = q('ov-count');
const countNum = q('count-num');
const ovRest = q('ov-rest');
const restNum = q('rest-num');
const txtSet = q('txt-set');
const txtRep = q('txt-rep');
const lblRep = q('lbl-rep');
const barSet = q('bar-set');
const barRep = q('bar-rep');
const btnStart=q('btn-start');
const btnStop=q('btn-stop');
const btnStopHeader=q('btn-stop-header');

q('year').textContent = new Date().getFullYear();

/* ==================== Persistence ==================== */
function saveSettings(){
  const payload = {
    mode: state.mode, repType: state.repType,
    selectedColors: state.selectedColors, selectedBgColors: state.selectedBgColors,
    selectedNumbers: state.selectedNumbers, selectedDirections: state.selectedDirections,
    appearanceMs: state.appearanceMs, intervalMs: state.intervalMs,
    sets: state.sets, reps: state.reps, setDurationSec: state.setDurationSec, restSec: state.restSec,
    sizeVH: state.sizeVH, randomPos: state.randomPos, beep: state.beep, autoFullscreen: state.autoFullscreen,
    multiPool: state.multiPool,
  };
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }catch(e){}
}
function loadSettings(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
    const s = JSON.parse(raw);
    Object.assign(state, s);
    // répercuter dans l'UI
    inpAppear.value = state.appearanceMs;
    inpInterval.value = state.intervalMs;
    inpSets.value = state.sets;
    inpReps.value = state.reps;
    inpSetDur.value = state.setDurationSec;
    inpRest.value = state.restSec;
    inpSize.value = state.sizeVH;
    chkRand.checked = state.randomPos;
    chkBeep.checked = state.beep;
    chkAutoFS.checked = state.autoFullscreen;
    updateRepTypeUI(); updateVisibility(); refreshModeChips();
  }catch(e){}
}

/* ==================== Modes ==================== */
const MODES = [
  ['stroop','Stroop'], ['chiffres','Chiffres'], ['couleur','Couleur'],
  ['directions','Directions'], ['chiffreCouleur','Chiffre + Couleur'],
  ['directionCouleur','Direction + Couleur'], ['multi','Multi']
];
const modeChips = q('mode-chips');
MODES.forEach(([key,label])=>{
  const b=document.createElement('button'); b.className='chip'+(state.mode===key?' active':''); b.textContent=label; b.dataset.mode=key;
  b.addEventListener('click', ()=>{ state.mode=key; saveSettings(); updateVisibility(); refreshModeChips(); });
  modeChips.appendChild(b);
});
function refreshModeChips(){ Array.from(modeChips.children).forEach(ch=> ch.classList.toggle('active', ch.dataset.mode===state.mode)); }

/* ==================== Sélections ==================== */
const swColors = q('swatches-colors');
const swBgs = q('swatches-bgs');
function makeSwatch(container, list, selectedArr){
  container.innerHTML='';
  list.forEach(c=>{
    const b=document.createElement('button'); b.className='swatch'; b.style.background=c.hex; b.title=c.name; b.dataset.name=c.name;
    b.textContent=c.outline ? c.name : c.name.slice(0,2);
    if(c.outline){ b.style.color='#111'; b.style.fontSize='9px'; }
    b.classList.toggle('active', selectedArr.includes(c.name));
    b.addEventListener('click', ()=>{ const i=selectedArr.indexOf(c.name); if(i>=0) selectedArr.splice(i,1); else selectedArr.push(c.name); b.classList.toggle('active', selectedArr.includes(c.name)); saveSettings(); });
    container.appendChild(b);
  });
}
makeSwatch(swColors, COLORS, state.selectedColors);
makeSwatch(swBgs, COLORS, state.selectedBgColors);

const chipsNumbers = q('chips-numbers');
NUMBERS.forEach(n=>{ const b=document.createElement('button'); b.className='chip'; if(state.selectedNumbers.includes(n)) b.classList.add('active'); b.textContent=String(n); b.dataset.n=String(n);
  b.addEventListener('click', ()=>{ const v=Number(b.dataset.n); const i=state.selectedNumbers.indexOf(v); if(i>=0){ state.selectedNumbers.splice(i,1); b.classList.remove('active'); } else { state.selectedNumbers.push(v); b.classList.add('active'); } saveSettings(); });
  chipsNumbers.appendChild(b);
});

const chipsDirs = q('chips-dirs');
DIRECTIONS.forEach(d=>{ const b=document.createElement('button'); b.className='chip'; if(state.selectedDirections.includes(d.key)) b.classList.add('active'); b.textContent=d.label; b.dataset.key=d.key;
  b.addEventListener('click', ()=>{ const k=b.dataset.key; const i=state.selectedDirections.indexOf(k); if(i>=0){ state.selectedDirections.splice(i,1); b.classList.remove('active'); } else { state.selectedDirections.push(k); b.classList.add('active'); } saveSettings(); });
  chipsDirs.appendChild(b);
});

const chipsMulti = q('chips-multi');
const multiMap = { stroop:'Stroop', chiffres:'Chiffres', couleur:'Couleur', directions:'Directions', chiffreCouleur:'Chiffre + Couleur', directionCouleur:'Direction + Couleur' };
Object.entries(multiMap).forEach(([k,label])=>{
  const b=document.createElement('button'); b.className='chip'; if(state.multiPool[k]) b.classList.add('active'); b.textContent=label; b.dataset.k=k;
  b.addEventListener('click', ()=>{ state.multiPool[k]=!state.multiPool[k]; b.classList.toggle('active', !!state.multiPool[k]); saveSettings(); });
  chipsMulti.appendChild(b);
});

/* ==================== Inputs ==================== */
const inpAppear=q('inp-appear'), inpInterval=q('inp-interval'), inpSets=q('inp-sets'), inpReps=q('inp-reps'),
      inpSetDur=q('inp-setdur'), inpRest=q('inp-rest'), inpSize=q('inp-size'),
      chkRand=q('chk-rand'), chkBeep=q('chk-beep'), chkAutoFS=q('chk-autofs');

inpAppear.addEventListener('input', ()=> { state.appearanceMs = clamp(Number(inpAppear.value)||500, 50, 5000); saveSettings(); });
inpInterval.addEventListener('input', ()=> { state.intervalMs = clamp(Number(inpInterval.value)||0, 0, 5000); saveSettings(); });
inpSets.addEventListener('input', ()=> { state.sets = clamp(Number(inpSets.value)||1, 1, 999); updateProgress(); saveSettings(); });
inpReps.addEventListener('input', ()=> { state.reps = clamp(Number(inpReps.value)||1, 1, 999); updateProgress(); saveSettings(); });
inpSetDur.addEventListener('input', ()=> { state.setDurationSec = clamp(Number(inpSetDur.value)||1, 1, 3600); updateProgress(); saveSettings(); });
inpRest.addEventListener('input', ()=> { state.restSec = clamp(Number(inpRest.value)||1, 1, 3600); saveSettings(); });
inpSize.addEventListener('input', ()=> { state.sizeVH = clamp(Number(inpSize.value)||24, 8, 40); saveSettings(); relayoutIfVisible(); });
chkRand.addEventListener('change', ()=> { state.randomPos = chkRand.checked; saveSettings(); relayoutIfVisible(); });
chkBeep.addEventListener('change', ()=> { state.beep = chkBeep.checked; saveSettings(); });
chkAutoFS.addEventListener('change', ()=> { state.autoFullscreen = chkAutoFS.checked; saveSettings(); });

// Rep type chips
Array.from(document.querySelectorAll('[data-reptype]')).forEach(btn=>{
  btn.addEventListener('click', ()=>{
    Array.from(document.querySelectorAll('[data-reptype]')).forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    state.repType = btn.dataset.reptype;
    updateRepTypeUI();
    saveSettings();
  })
});

function updateRepTypeUI(){
  const byDur = state.repType==='duree';
  q('box-reps').style.display = byDur ? 'none' : '';
  q('box-duration').style.display = byDur ? '' : 'none';
  lblRep.textContent = byDur ? 'Durée du set' : 'Répétitions';
}
function updateVisibility(){
  const m=state.mode;
  q('sec-numbers').style.display = (m==='chiffres'||m==='chiffreCouleur'||m==='multi') ? '' : 'none';
  q('sec-dirs').style.display    = (m==='directions'||m==='directionCouleur'||m==='multi') ? '' : 'none';
  q('sec-bgs').style.display     = (m==='chiffreCouleur'||m==='directionCouleur'||m==='multi') ? '' : 'none';
  q('sec-multi').style.display   = (m==='multi') ? '' : 'none';
}
updateVisibility(); updateRepTypeUI();

/* ==================== Beep ==================== */
let audioCtx=null; function ensureCtx(){ if(!audioCtx){ const C=window.AudioContext||window.webkitAudioContext; if(C) audioCtx=new C(); } return audioCtx; }
function beep(d=150,f=880,v=.22){
  try{ const c=ensureCtx(); if(!c) return; const o=c.createOscillator(); const g=c.createGain();
    o.type='sine'; o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(c.destination);
    o.start(); setTimeout(()=>{ try{o.stop()}catch(e){} }, d);
  }catch(e){}
}

/* ==================== Stimulus (anti-dépassement + position sûre) ==================== */
function clearStimulus(){ Array.from(stage.querySelectorAll('.bg-layer,.stimulus')).forEach(n=>n.remove()); }

function measureAndPlace(node){
  // Placer centré à scale(1) puis mesurer
  node.style.transform='translate(-50%, -50%) scale(1)';
  node.style.top='50%'; node.style.left='50%';

  const rectStage=stage.getBoundingClientRect();
  const box=node.getBoundingClientRect();
  const MARGIN=24;
  const availW=Math.max(1,rectStage.width - MARGIN*2);
  const availH=Math.max(1,rectStage.height - MARGIN*2);
  let sc=Math.min(availW/box.width, availH/box.height);
  if(!Number.isFinite(sc)||sc<=0) sc=1; sc=Math.min(sc,1);

  // Position aléatoire sûre si demandé
  if(state.randomPos){
    const w=box.width*sc, h=box.height*sc;
    const minX=MARGIN + w/2, maxX=rectStage.width - (MARGIN + w/2);
    const minY=MARGIN + h/2, maxY=rectStage.height - (MARGIN + h/2);
    const left=maxX>=minX ? Math.random()*(maxX-minX)+minX : rectStage.width/2;
    const top =maxY>=minY ? Math.random()*(maxY-minY)+minY : rectStage.height/2;
    node.style.left=left+'px'; node.style.top=top+'px';
  }
  node.style.transform=`translate(-50%, -50%) scale(${sc})`;
}

function showStimulus(){
  clearStimulus();
  const mode = (state.mode==='multi')
    ? (()=>{
        const allowed=Object.entries(state.multiPool).filter(([,v])=>v).map(([k])=>k);
        const fallback=['stroop','chiffres','couleur','directions','chiffreCouleur','directionCouleur'];
        return randFrom(allowed.length?allowed:fallback);
      })()
    : state.mode;

  // helpers de tirage
  const pickColor = ()=> { const arr = COLORS.filter(c=>state.selectedColors.includes(c.name)); return randFrom(arr.length?arr:COLORS); };
  const pickBg    = ()=> { const arr = COLORS.filter(c=>state.selectedBgColors.includes(c.name)); return randFrom(arr.length?arr:COLORS); };
  const pickNum   = ()=> { const arr = state.selectedNumbers.length?state.selectedNumbers:NUMBERS; return randFrom(arr); };
  const pickDir   = ()=> { const arr = DIRECTIONS.filter(d=>state.selectedDirections.includes(d.key)); return randFrom(arr.length?arr:DIRECTIONS); };

  let node=null;

  if(mode==='stroop'){
    const word=pickColor(); const ink=pickColor();
    node=document.createElement('div'); node.textContent=word.name; node.style.color=ink.hex;
  } else if(mode==='chiffres'){
    const n=pickNum(); const ink=pickColor();
    node=document.createElement('div'); node.textContent=String(n); node.style.color=ink.hex;
  } else if(mode==='couleur'){
    const c=pickColor();
    const bgEl=document.createElement('div'); bgEl.className='bg-layer'; bgEl.style.background=c.hex; stage.appendChild(bgEl);
  } else if(mode==='directions'){
    const d=pickDir();
    node=document.createElement('div'); node.textContent=d.label; node.style.color='#111';
  } else if(mode==='chiffreCouleur'){
    const n=pickNum(); const ink=pickColor(); const b=pickBg();
    const bgEl=document.createElement('div'); bgEl.className='bg-layer'; bgEl.style.background=b.hex; stage.appendChild(bgEl);
    node=document.createElement('div'); node.textContent=String(n); node.style.color=ink.hex;
  } else if(mode==='directionCouleur'){
    const d=pickDir(); const ink=pickColor(); const b=pickBg();
    const bgEl=document.createElement('div'); bgEl.className='bg-layer'; bgEl.style.background=b.hex; stage.appendChild(bgEl);
    node=document.createElement('div'); node.textContent=d.label; node.style.color=ink.hex;
  }

  if(node){
    node.className='stimulus';
    node.style.fontSize = state.sizeVH + 'vh';
    stage.appendChild(node);
    measureAndPlace(node);
  }
}

function relayoutIfVisible(){
  const cur = stage.querySelector('.stimulus');
  if(cur){ measureAndPlace(cur); }
}
window.addEventListener('resize', ()=>{ relayoutIfVisible(); });
window.addEventListener('orientationchange', ()=>{ setTimeout(relayoutIfVisible, 120); });

/* ==================== Progress ==================== */
function updateProgress(){
  const setPct = (state.currentSet / Math.max(1, state.sets)) * 100; barSet.style.width = Math.round(setPct) + '%'; txtSet.textContent = state.currentSet + '/' + state.sets;
  if(state.repType==='apparitions'){
    const repPct = (state.reps? (state.currentRep/state.reps) : 0) * 100; barRep.style.width = Math.round(repPct) + '%'; txtRep.textContent = state.currentRep + '/' + state.reps;
  } else {
    const pct = clamp(state.runningSetElapsedMs / Math.max(1, state.setDurationSec*1000), 0, 1) * 100;
    barRep.style.width = Math.round(pct) + '%';
    txtRep.textContent = Math.floor(state.runningSetElapsedMs/1000) + 's / ' + state.setDurationSec + 's';
  }
}

/* ==================== Session ==================== */
let rafId=0; let elapsedStart=0;
function setRunningUI(on){
  btnStart.style.display = on ? 'none' : '';
  btnStop.style.display = on ? '' : 'none';
  btnStopHeader.style.display = on ? '' : 'none';
}

function stopSession(){
  state.cancelled=true;
  state.phase='idle';
  state.currentSet=0; state.currentRep=0; state.runningSetElapsedMs=0;
  clearStimulus(); updateProgress();
  cancelAnimationFrame(rafId);
  setRunningUI(false);
  ovCount.style.display='none'; ovRest.style.display='none';
}

function tickElapsed(){
  state.runningSetElapsedMs = performance.now() - elapsedStart; updateProgress();
  if(!state.cancelled && state.phase==='running') rafId = requestAnimationFrame(tickElapsed);
}

async function runSet(index){
  state.currentSet=index+1; state.currentRep=0; state.runningSetElapsedMs=0; updateProgress();
  elapsedStart=performance.now(); cancelAnimationFrame(rafId); rafId=requestAnimationFrame(tickElapsed);

  if(state.repType==='apparitions'){
    for(let i=0;i<state.reps;i++){
      if(state.cancelled) return;
      state.currentRep=i+1; updateProgress();
      showStimulus(); if(state.beep) beep();
      await new Promise(r=>setTimeout(r,state.appearanceMs)); if(state.cancelled) return;
      clearStimulus();
      await new Promise(r=>setTimeout(r,state.intervalMs)); if(state.cancelled) return;
    }
  } else {
    const hard=state.setDurationSec*1000; let count=0;
    while(!state.cancelled && (performance.now()-elapsedStart)<hard){
      state.currentRep=++count; updateProgress();
      showStimulus(); if(state.beep) beep();
      await new Promise(r=>setTimeout(r,state.appearanceMs)); if(state.cancelled) return;
      clearStimulus();
      const remaining = hard - (performance.now()-elapsedStart);
      if(remaining<=0) break;
      await new Promise(r=>setTimeout(r, Math.min(state.intervalMs, remaining)));
    }
  }
}

async function startSession(){
  setRunningUI(true);
  state.cancelled=false;

  // Plein écran au démarrage (sur la zone stimuli)
  if(state.autoFullscreen && !document.fullscreenElement && stageShell.requestFullscreen){
    try{ await stageShell.requestFullscreen({ navigationUI: 'hide' }); }catch(e){}
  }

  state.phase='countdown';
  for(let c=3;c>0;c--){
    if(state.cancelled) return stopSession();
    ovCount.style.display='grid';
    countNum.textContent=String(c);
    await new Promise(r=>setTimeout(r,1000));
  }
  ovCount.style.display='none';

  for(let s=0;s<state.sets;s++){
    if(state.cancelled) return stopSession();
    state.phase='running';
    await runSet(s);
    if(state.cancelled) return stopSession();
    if(s<state.sets-1){
      state.phase='rest';
      for(let t=state.restSec;t>0;t--){
        if(state.cancelled) return stopSession();
        ovRest.style.display='grid'; restNum.textContent=String(t);
        await new Promise(r=>setTimeout(r,1000));
      }
      ovRest.style.display='none';
      if(state.beep) beep(250,660,0.25);
    }
  }
  state.phase='finished';
  setRunningUI(false);
}

/* ==================== Boutons & Raccourcis ==================== */
btnStart.addEventListener('click', startSession);
btnStop.addEventListener('click', stopSession);
btnStopHeader.addEventListener('click', stopSession);
q('btn-toggle-fs').addEventListener('click', ()=>{ if(document.fullscreenElement) document.exitFullscreen(); else stageShell.requestFullscreen?.({navigationUI:'hide'}); });
q('btn-exit-fs').addEventListener('click', ()=>{ if(document.fullscreenElement) document.exitFullscreen(); });

document.addEventListener('fullscreenchange', ()=>{ q('btn-exit-fs').style.display = document.fullscreenElement ? '' : 'none'; });

window.addEventListener('keydown', (e)=>{
  if(e.code==='Space'){ e.preventDefault(); (state.phase==='idle'||state.phase==='finished')? startSession() : stopSession(); }
  if(e.key && e.key.toLowerCase()==='f'){ if(document.fullscreenElement) document.exitFullscreen(); else stageShell.requestFullscreen?.({navigationUI:'hide'}); }
});

/* ==================== Init ==================== */
function setMobileVh(){ document.documentElement.style.setProperty('--app-vh', window.innerHeight*0.01 + 'px'); }
window.addEventListener('resize', setMobileVh); window.addEventListener('orientationchange', ()=> setTimeout(setMobileVh, 150));
setMobileVh();

function updateProgressBarsInit(){ state.currentSet=0; state.currentRep=0; state.runningSetElapsedMs=0; updateProgress(); }
function afterLoadSwatches(){ makeSwatch(swColors, COLORS, state.selectedColors); makeSwatch(swBgs, COLORS, state.selectedBgColors); }

loadSettings();
afterLoadSwatches();
updateProgressBarsInit();
</script>
</body>
</html>
